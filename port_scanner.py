import socket
from IPy import IP


class PortScan:
    """
    This class is responsible to scan available ports in a given range and address.
    """
    banners = []
    open_ports = []

    def __init__(self, target, port_num):
        self._target = target
        self._port_num = port_num
        socket.setdefaulttimeout(0.5)
        pass

    def scan(self):
        """
        This function is responsible to send a proper scan request with the initial data.
        """
        for port in range(1, self._port_num):
            self.scan_port(port)

        # room for improvement would be selecting known ports [21, 22, 25, 80, 110, 443]

    def check_ip(self):
        """
        This function is responsible to check the target ip address and convert it if its not in the correct format.
        :return: the numbers format of the address (i.e. 192.168.1.1)
        """
        try:
            IP(self._target)
            return self._target
        except ValueError:
            return socket.gethostbyname(self._target)

    def scan_port(self, port):
        """
        This function is responsible to scan and print iff the given port is open within the initial ip.
        :param port: the given port.
        """
        try:
            converted_ip = self.check_ip()
            sock = socket.socket()
            sock.connect((converted_ip, port))
            self.open_ports.append(port)

            try:
                banner = sock.recv(1024).decode().strip('\n')
                self.banners.append(banner)

            except:
                self.banners.append("N/A")

            sock.close()

        except Exception as e:
            if str(e) != "timed out":
                print(str(e))
